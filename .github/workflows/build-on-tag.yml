name: Build on Tag

on:
  push:
    tags:
      - 'v*' # Triggers on any tag starting with 'v'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 🏗 Setup repo
        uses: actions/checkout@v3

      - name: 🏗 Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 18.x

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: |
          cd app
          yarn install
          sudo apt-get update && sudo apt-get install -y jq

      - name: 🚀 Build APK
        if: success()
        id: build-preview
        run: |
          cd app
          BUILD_URL=$(eas build --platform android --profile preview --non-interactive --json | jq -r '.[] | select(.platform=="android") | .artifacts.buildUrl')
          echo "preview_url=$BUILD_URL" >> $GITHUB_OUTPUT

      - name: 🚀 Build production bundle
        if: success()
        id: build-production
        run: |
          cd app
          BUILD_URL=$(eas build --platform android --profile production --non-interactive --json | jq -r '.[] | select(.platform=="android") | .artifacts.buildUrl')
          echo "production_url=$BUILD_URL" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: success() && startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          body: |
            ## Android Builds
            
            - [📱 Download Preview APK](${{ steps.build-preview.outputs.preview_url }})
            - [📱 Download Production Bundle](${{ steps.build-production.outputs.production_url }})
            
            The preview APK can be installed directly on Android devices.
            The production bundle is for Google Play Store submission.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
